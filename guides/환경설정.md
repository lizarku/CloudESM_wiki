# 1. 환경설정

> **CloudESM SOAR 플랫폼 설치 및 초기 구축 가이드**

[← 통합매뉴얼로 돌아가기](../통합매뉴얼.md)

---

## ⚡ 빠른 시작 (Quick Start)

**처음 시작하는 분을 위한 3단계 가이드**

### Step 1: 설치 방법 선택

- **개발/테스트 목적** → [로컬 설치 (WSL2)](#로컬-설치-wsl2) 권장
- **운영 환경 배포** → [서버 설치 (CentOS VM)](#서버-설치-centos-vm) 권장

### Step 2: 필수 정보 준비

```
DB 계정 정보 (기본값):
- 사용자명: root
- 비밀번호: admin@123
- 호스트: 10.1.34.26 (로컬) / 10.1.34.69 (외부)
- 포트: 13306

웹 콘솔 계정 (기본값):
- ID: admin
- PW: admin@123
- URL: https://localhost:8443/ (로컬)
```

### Step 3: 설치 진행

1. [WSL2 설치](#wsl2-설치) (Windows 환경) 또는 [CentOS 설치](#서버-설치-centos-vm) (운영 환경)
2. [데이터베이스 설정](#데이터베이스-설정) 확인
3. [서비스 시작](#서비스-관리-명령어-요약)
4. [웹 콘솔 접속](#서비스-관리-명령어-요약) 테스트

---

## 목차
1. [시스템 아키텍처](#시스템-아키텍처)
2. [설치 방법 선택](#설치-방법-선택)
3. [로컬 설치 (WSL2)](#로컬-설치-wsl2)
4. [서버 설치 (CentOS VM)](#서버-설치-centos-vm)
5. [네트워크 설정](#네트워크-설정)
6. [데이터베이스 설정](#데이터베이스-설정)
7. [로그 설정](#로그-설정)
8. [서비스 디렉토리 구조](#서비스-디렉토리-구조)

---

## 시스템 아키텍처

### 시스템 개요

eyeCloudXOAR은 **마이크로서비스 아키텍처**로 구축된 보안 이벤트 관리 플랫폼입니다.
로그 수집, 정규화, 분석, 검색 및 SOAR 기능을 처리하는 여러 Java 기반 서비스로 구성되어 있습니다.

### 마이크로서비스 구조

플랫폼은 **데이터 파이프라인 아키텍처**를 따릅니다:

```
[로그 소스]
    ↓
┌─────────────────────────────────────┐
│  1. 데이터 수집 레이어                │
│  - Collector: 로그 수신/수집          │
│  - Agent: 원격 로그 수집              │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  2. 데이터 처리 레이어                │
│  - Normalizer: 로그 정규화            │
│  - Reducer: 로그 집계/축소            │
│  - Shovel Server: 데이터 전송 관리    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  3. 저장 및 검색 레이어               │
│  - Searcher: Lucene 검색 엔진         │
│  - Store/CDMEngine: 데이터 관리       │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  4. 분석 레이어                       │
│  - Analyzer: 보안 이벤트 분석         │
│  - Analyzer Assistant: 추가 분석      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  5. SOAR 구성 요소                    │
│  - Playbook Manager: 자동화 플레이북  │
│  - Ticket Manager: 인시던트 티켓      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  6. 웹 인터페이스                     │
│  - Tomcat 9: 서블릿 컨테이너          │
│  - Spring MVC: 웹 애플리케이션        │
└─────────────────────────────────────┘
```

### 기술 스택

| 계층 | 기술 |
|------|------|
| **Java** | Zulu JDK 11 |
| **웹 프레임워크** | Spring MVC, JSP/JSTL |
| **서블릿 컨테이너** | Apache Tomcat 9 |
| **검색 엔진** | Apache Lucene 7.x |
| **데이터베이스** | MariaDB, MyBatis ORM |
| **프론트엔드** | CKEditor, D3.js, C3.js, Three.js |
| **로깅** | Log4j2 |
| **운영체제** | Ubuntu 24.04 on WSL2 |

---

## 설치 방법 선택

CloudESM SOAR 플랫폼은 두 가지 방법으로 설치할 수 있습니다:

### 1. 로컬 설치 (WSL2)

**대상**: Windows 환경에서 개발/테스트용으로 설치

**특징**:
- Windows 10/11 PC에서 직접 실행
- WSL2 + Ubuntu 24.04 환경
- 빠른 설치 및 설정
- 개발 및 테스트에 적합
- 네트워크 설정 간편

**권장 사양**:
- RAM: 16GB 이상
- CPU: 4코어 이상
- 디스크: 100GB 이상

→ [로컬 설치 (WSL2) 바로가기](#로컬-설치-wsl2)

---

### 2. 서버 설치 (CentOS VM)

**대상**: 운영 환경에서 서비스 배포

**특징**:
- VMware 가상머신 환경
- CentOS 8 기반
- 안정적인 운영 환경
- 라이센스 발급 필요
- 방화벽 및 보안 설정 필수

**권장 사양**:
- RAM: 32GB 이상
- CPU: 8코어 이상
- 디스크: 500GB 이상

→ [서버 설치 (CentOS VM) 바로가기](#서버-설치-centos-vm)

---

## 로컬 설치 (WSL2)

### 개요

Windows에서 WSL2를 사용하여 CloudESM을 로컬 환경에 설치하는 방법입니다.

### WSL2 환경 설정

### WSL2 설치

#### 1. Windows에서 WSL2 활성화

```powershell
# PowerShell 관리자 권한으로 실행
wsl --install
wsl --set-default-version 2
```

#### 2. Ubuntu 24.04 설치

```powershell
wsl --install -d Ubuntu-24.04
```

#### 3. WSL2 버전 확인

```powershell
wsl --list --verbose
```

**출력 예시**:
```
NAME            STATE           VERSION
* Ubuntu-24.04  Running         2
```

### Ubuntu 환경 구성

#### 1. 프로젝트 복사

Windows 파일시스템에서 WSL 네이티브 파일시스템으로 프로젝트를 복사합니다.

```bash
# WSL Ubuntu에서 실행
mkdir -p ~/projects
cp -r /mnt/c/projects/eyeCloudXOAR_V4_unpackage/CloudESM_CRAT ~/projects/
```

**이유**: WSL2에서는 네이티브 파일시스템(`/home/user/`)이 Windows 마운트(`/mnt/c/`)보다 **10-100배 빠릅니다**.

#### 2. 심볼릭 링크 생성

```bash
sudo ln -sf ~/projects/CloudESM_CRAT /CloudESM
ls -la /CloudESM  # 확인
```

#### 3. 필수 디렉토리 생성

```bash
cd /CloudESM
mkdir -p logs store data/processing data/storage
```

#### 4. 권한 설정

```bash
# Java 실행 권한
chmod +x /CloudESM/app/java/zulu11/bin/java

# 모든 쉘 스크립트 실행 권한
find /CloudESM/app -name "*.sh" -exec chmod +x {} \;
```

#### 5. CRLF → LF 변환

Windows에서 작성된 스크립트는 줄바꿈 문자가 `CRLF`인데, Linux는 `LF`를 사용합니다.

```bash
# dos2unix 설치
sudo apt update
sudo apt install dos2unix -y

# 모든 .sh 파일 변환
find /CloudESM/app -name "*.sh" -exec dos2unix {} \;
```

### 완료 확인

```bash
# 디렉토리 구조 확인
ls -la /CloudESM/

# 출력 예시:
# lrwxrwxrwx 1 root root   36 Nov  4 15:00 /CloudESM -> /home/user/projects/CloudESM_CRAT
```

### WSL2 고정 IP 할당 (선택)

WSL2는 기본적으로 동적 IP를 사용합니다. 고정 IP가 필요한 경우:

```bash
# 1. Ubuntu에 고정 IP 추가
wsl -d Ubuntu -u root ip addr add 192.168.254.16/24 broadcast 192.168.254.255 dev eth0 label eth0:1

# 2. Windows에 내부 IP 추가
netsh interface ip add address "vEthernet (WSL)" 192.168.254.100 255.255.255.0

# 3. 확인
wsl hostname -I
```

**주의**: WSL 재시작 시 설정이 초기화되므로 자동화 스크립트 사용을 권장합니다.

---

## 서버 설치 (CentOS VM)

### 개요

VMware 가상머신에서 CentOS 8을 사용하여 CloudESM을 운영 환경에 설치하는 방법입니다.

### 1. 사전 준비

#### 1.1 CentOS 8 ISO 다운로드

```bash
# Minimal ISO (네트워크 설치) 또는 DVD1 ISO (전체 설치) 다운로드
```

**다운로드 링크**: CentOS 공식 사이트 또는 Vault

#### 1.2 라이센스 발급

CloudESM 라이센스는 서버의 **MAC 주소** 기반으로 발급됩니다.

**라이센스 발급 사이트**:
```
https://ic.seculayer.com/main/user_license_info.do
```

**필요 정보**:
- 설치할 VM의 MAC 주소

#### 1.3 VMware Workstation 설치

```
VMware-workstation-full-17.5.2 이상
```

#### 1.4 제품 설치 파일 다운로드

**다운로드 위치**:
```
https://seculayer.atlassian.net/wiki/spaces/HOTFIX/pages/451477507/eyeCloudXOAR+V4.0_03_R2+Release+2
```

**파일 예시**:
```
eyeCloudXOAR_Ain1-4.0-03_20241230_R2.el8.noarch.sh
```

---

### 2. VM 설정

#### 2.1 VMware 가상머신 생성

**권장 사양**:
- **CPU**: 8 Core
- **RAM**: 32GB
- **디스크**: 500GB
- **네트워크**: Bridge 모드

**네트워크 설정**:
```
Network Adapter: Bridged (브릿지 모드)
```

→ 브릿지 모드를 사용하면 VM이 물리 네트워크에 직접 연결됩니다.

#### 2.2 CentOS 설치

1. VMware에서 CentOS 8 ISO로 부팅
2. Installation Destination에서 디스크 선택
3. Network & Host Name에서 네트워크 활성화
4. Root 비밀번호 설정: `admin@123` (또는 원하는 비밀번호)
5. 설치 완료 후 재부팅

---

### 3. CentOS 기본 설정

#### 3.1 기본 유틸리티 설치

```bash
# DNS 도구
sudo yum install -y bind-utils

# 네트워크 도구
sudo yum install -y net-tools wget curl
```

#### 3.2 EPEL 저장소 및 필수 패키지 설치

```bash
# EPEL 저장소 설치
sudo yum install -y epel-release

# 저장소 목록 갱신
sudo yum makecache

# 필수 패키지 설치
sudo yum install -y glibc-langpack-ko nmap nmon
```

---

### 4. DNS 및 Repository 문제 해결

CentOS 8은 **EOL(End of Life)** 상태이므로 저장소 설정이 필요합니다.

#### 4.1 DNS 문제 확인 및 해결

```bash
# DNS 테스트
ping -c 3 8.8.8.8        # 성공해야 함
ping -c 3 google.com     # 실패하면 DNS 문제

# DNS 서버 설정 (인터페이스 이름 확인: ens160, eth0 등)
sudo nmcli con mod ens160 ipv4.dns "8.8.8.8 8.8.4.4"
sudo nmcli con mod ens160 ipv4.ignore-auto-dns yes

# 연결 재시작
sudo nmcli con down ens160 && sudo nmcli con up ens160

# 확인
ping -c 3 google.com
```

#### 4.2 CentOS 8 EOL Repository 변경

```bash
# CentOS 버전 확인
cat /etc/centos-release

# Repository를 vault.centos.org로 변경
sudo sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
sudo sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

# yum 캐시 초기화
sudo yum clean all
sudo rm -rf /var/cache/yum

# 확인
sudo yum update
```

---

### 5. 방화벽 설정

#### 5.1 방화벽 상태 확인

```bash
sudo systemctl status firewalld
```

#### 5.2 필요한 포트 오픈

```bash
# eyeCloudXOAR 웹 콘솔
sudo firewall-cmd --permanent --add-port=8443/tcp

# eyeCloudXOAR MariaDB (외부 접속 시)
sudo firewall-cmd --permanent --add-port=13306/tcp

# Syslog 수집
sudo firewall-cmd --permanent --add-port=514/udp
sudo firewall-cmd --permanent --add-port=514/tcp

# Secure Syslog
sudo firewall-cmd --permanent --add-port=6514/tcp

# 커스텀 로그 수집
sudo firewall-cmd --permanent --add-port=10514/tcp

# 방화벽 재시작
sudo firewall-cmd --reload

# 확인
sudo firewall-cmd --list-all
```

#### 5.3 포트 사용 확인

```bash
# 열린 포트 확인
ss -tunlp
```

---

### 6. CloudESM 솔루션 설치

#### 6.1 설치 파일 업로드

설치 파일을 VM으로 복사 (SCP, SFTP 등 사용):

```bash
# 예시: Windows에서 VM으로 복사
scp eyeCloudXOAR_Ain1-4.0-03_20241230_R2.el8.noarch.sh root@10.1.11.161:/tmp/
```

#### 6.2 설치 실행

```bash
# 설치 스크립트 실행
cd /tmp
sudo sh ./eyeCloudXOAR_Ain1-4.0-03_20241230_R2.el8.noarch.sh install
```

**설치 과정**:
- 패키지 압축 해제
- `/CloudESM/` 디렉토리 생성
- 서비스 설치
- 라이센스 적용
- DB 설정 (설치 중 계정 정보 입력)

**설치 중 입력 정보**:
- DB 호스트: `10.1.34.26` (로컬 환경) 또는 `10.1.34.69` (외부 DB)
- DB 포트: `13306`
- DB 사용자: `root`
- DB 비밀번호: `admin@123`

#### 6.3 타임존 설정

라이센스 검증을 위해 **KST(한국 표준시)** 설정이 필요합니다.

```bash
# 타임존 변경 (EDT → KST)
sudo ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

# 확인
date
```

**중요**: 서버 시간과 라이센스 발급 시간이 일치해야 라이센스가 정상 작동합니다.

---

### 7. 서비스 시작 및 확인

#### 7.1 CloudESM 서비스 시작

```bash
# 전체 서비스 시작
/CloudESM/app/start.sh
```

#### 7.2 프로세스 확인

```bash
# CloudESM 프로세스 확인
ps -ef | grep -i cloudesm

# 예상 출력: SearchEngine, AnalyzeEngine, Tomcat 등
```

#### 7.3 웹 콘솔 접속

```
https://<서버IP>:8443/

# 예시
https://10.1.11.161:8443/
```

**기본 계정**:
- ID: `admin`
- PW: `admin@123`

---

### 8. SSH 접속 설정 (선택)

로컬 PC에서 VM으로 SSH 접속을 허용하려면:

#### 8.1 SSH 서버 설치

```bash
# SSH 설치
sudo yum install -y openssh-server

# SSH 서비스 시작
sudo systemctl start sshd

# 부팅 시 자동 시작
sudo systemctl enable sshd

# 상태 확인
sudo systemctl status sshd
```

#### 8.2 방화벽에서 SSH 포트 열기

```bash
# SSH 포트 오픈 (22번 포트)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload

# 확인
sudo firewall-cmd --list-all
```

#### 8.3 IP 주소 확인

```bash
# IP 주소 확인 (인터페이스 이름: ens160)
ip addr show ens160
```

#### 8.4 로컬에서 SSH 접속

```bash
# Windows PowerShell 또는 Terminal에서
ssh root@10.1.11.161

# 또는 일반 사용자로 접속
ssh username@10.1.11.161
```

---

### 9. 트러블슈팅

#### 9.1 catalina.out 미생성 문제

**증상**: Tomcat 로그 파일(`catalina.out`)이 생성되지 않음

**해결 방법**:
```bash
# slf4j-reload4j JAR 파일 이동
sudo mv /CloudESM/app/www/ROOT/WEB-INF/lib/slf4j-reload4j-1.7.35.jar /tmp/

# Tomcat 재시작
/CloudESM/app/tomcat9/bin/shutdown.sh
/CloudESM/app/tomcat9/bin/startup.sh
```

#### 9.2 라이센스 거부 문제

**원인**: 서버 시간과 라이센스 발급 시간 불일치 (EDT vs KST)

**해결 방법**:
```bash
# KST로 변경
sudo ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

# 확인
date

# CloudESM 재시작
/CloudESM/app/stop.sh
/CloudESM/app/start.sh
```

#### 9.3 MariaDB 완전 삭제 (재설치 필요시)

```bash
# MariaDB 완전 삭제 스크립트
sudo systemctl stop mariadb
sudo systemctl disable mariadb
sudo yum remove -y mariadb mariadb-server mariadb-libs mariadb-common
sudo rm -rf /var/lib/mysql /etc/my.cnf /etc/my.cnf.d /etc/mysql \
       /usr/lib64/mysql /usr/share/mysql /var/log/mariadb /var/log/mysql /run/mariadb
sudo userdel -r mysql 2>/dev/null
sudo groupdel mysql 2>/dev/null
sudo rm -f /usr/lib/systemd/system/mariadb.service /usr/lib/systemd/system/mysql.service
sudo systemctl daemon-reload
sudo systemctl reset-failed
```

---

### 10. 서버 설치 체크리스트

- [ ] CentOS 8 설치 완료
- [ ] VMware 네트워크를 Bridge 모드로 설정
- [ ] DNS 문제 해결 (`ping google.com` 성공)
- [ ] CentOS 8 Repository를 vault.centos.org로 변경
- [ ] 필수 패키지 설치 (glibc-langpack-ko, nmap, nmon)
- [ ] 방화벽 포트 오픈 (8443, 13306, 514, 6514, 10514)
- [ ] 라이센스 발급 완료 (MAC 주소 기반)
- [ ] CloudESM 설치 스크립트 실행 완료
- [ ] 타임존을 KST로 설정
- [ ] 서비스 시작 성공 (`ps -ef | grep cloudesm`)
- [ ] 웹 콘솔 접속 성공 (`https://<서버IP>:8443/`)

---

## 네트워크 설정

> **참고**: 이 섹션은 로컬 설치(WSL2)와 서버 설치(CentOS) 모두에 적용됩니다.

### 고정 IP 설정 (로컬 WSL2)

WSL2는 재부팅 시 IP와 MAC 주소가 변경됩니다. 고정 IP를 설정하여 안정적인 네트워크 환경을 구축합니다.

#### 1. 고정 IP 설정 스크립트 사용

CloudESM은 **자동 네트워크 설정 스크립트**를 포함하고 있습니다.

```bash
cd /CloudESM/app
./fix_network.sh
```

#### 2. 고정 IP 설정값 (WSL2 환경)

| 항목 | 값 |
|------|---|
| **IP 주소** | 172.26.94.100/20 |
| **Gateway** | 172.26.80.1 |
| **DNS** | 10.255.255.254 |
| **MAC 주소** | 00:15:5d:aa:bb:cc |

#### 3. 수동 설정 (필요시)

```bash
# 기존 IP 삭제
sudo ip addr flush dev eth0

# 새 IP 할당
sudo ip addr add 172.26.94.100/20 dev eth0

# MAC 주소 변경
sudo ip link set dev eth0 address 00:15:5d:aa:bb:cc

# 네트워크 인터페이스 활성화
sudo ip link set dev eth0 up

# 기본 게이트웨이 설정
sudo ip route add default via 172.26.80.1
```

#### 4. DNS 설정

```bash
# /etc/resolv.conf 수정
sudo bash -c 'echo "nameserver 10.255.255.254" > /etc/resolv.conf'
```

#### 5. 네트워크 확인

```bash
# IP 주소 확인
ip addr show eth0

# 게이트웨이 확인
ip route

# DNS 확인
cat /etc/resolv.conf

# 연결 테스트
ping -c 3 10.1.34.69  # DB 서버
```

### 네트워크 설정 (서버 CentOS)

서버 환경에서는 고정 IP를 설정하는 것이 권장됩니다.

#### CentOS 고정 IP 설정

```bash
# 네트워크 인터페이스 확인 (예: ens160)
ip addr

# NetworkManager로 고정 IP 설정
sudo nmcli con mod ens160 ipv4.addresses 10.1.11.161/24
sudo nmcli con mod ens160 ipv4.gateway 10.1.11.1
sudo nmcli con mod ens160 ipv4.dns "8.8.8.8 8.8.4.4"
sudo nmcli con mod ens160 ipv4.method manual

# 연결 재시작
sudo nmcli con down ens160 && sudo nmcli con up ens160

# 확인
ip addr show ens160
```

### 방화벽 설정

#### Ubuntu (WSL2)

```bash
# UFW 상태 확인
sudo ufw status

# 필요한 포트 열기
sudo ufw allow 8080/tcp   # Tomcat HTTP
sudo ufw allow 8443/tcp   # Tomcat HTTPS
sudo ufw allow 13306/tcp  # MariaDB
```

#### CentOS (서버)

방화벽 설정은 [서버 설치 (CentOS VM)](#서버-설치-centos-vm)의 5. 방화벽 설정 참조

### 포트 매핑

| 서비스 | 포트 | 프로토콜 | 설명 |
|--------|------|----------|------|
| Tomcat HTTP | 8080 | TCP | 웹 서버 |
| Tomcat HTTPS | 8443 | TCP | 보안 웹 서버 |
| MariaDB | 13306 | TCP | 데이터베이스 |
| Searcher | 9092 | TCP | 검색 엔진 내부 |
| Collector | 9104 | TCP | 로그 수집 |
| Normalizer | 9292 | TCP | 로그 정규화 |

---

## 데이터베이스 설정

### MariaDB 설정

#### 1. DB 서버 정보

| 항목 | 값 |
|------|---|
| **호스트** | 10.1.34.26 (로컬) / 10.1.34.69 (외부) |
| **포트** | 13306 |
| **데이터베이스** | CloudESM |
| **사용자명** | root |
| **비밀번호** | admin@123 |

#### 2. DB 연결 테스트

```bash
# MariaDB 클라이언트 설치
sudo apt install mariadb-client -y

# 로컬 DB 연결 테스트
mysql -h 10.1.34.26 -P 13306 -u root -p
# 비밀번호 입력: admin@123

# 또는 외부 DB 연결 테스트
mysql -h 10.1.34.69 -P 13306 -u root -p
# 비밀번호 입력: admin@123
```

### DB 계정 권한

CloudESM의 각 서비스는 암호화된 DB 접속 정보를 사용합니다.

#### 암호화 방식

- **알고리즘**: AES-256 CBC Mode
- **키/IV**: "AES/CBC/PKCS5Padding" 문자열의 처음 16바이트
- **인코딩**: Base64

#### 암호화된 값 예시

```properties
# DB 계정 정보는 AES-256으로 암호화되어 저장됩니다
jdbc.username=[암호화된_root_계정]
jdbc.password=[암호화된_admin@123_비밀번호]

# 실제 값은 설치 시 자동으로 생성됩니다
# 평문: root / admin@123
```

#### DB 설정 파일 위치

```
/CloudESM/app/analyzer/conf/db.properties
/CloudESM/app/analyzer_assistant/conf/db.properties
/CloudESM/app/bigdata/conf/db.properties
/CloudESM/app/normalizer/conf/db.properties
/CloudESM/app/pms/server/conf/db.properties
/CloudESM/app/procmonitor/conf/db.properties
/CloudESM/app/reducer/conf/db.properties
/CloudESM/app/shovel_server/conf/db.properties
/CloudESM/app/soar_playbook_manager/conf/db.properties
/CloudESM/app/soar_ticket_manager/conf/db.properties
/CloudESM/app/store/conf/db.properties
/CloudESM/app/www/ROOT/WEB-INF/conf/jdbc-mysql.properties
```

#### DB 설정 예시

```properties
jdbc.driver=org.mariadb.jdbc.Driver
jdbc.url=jdbc:mariadb://10.1.34.69:13306/CloudESM?autoReconnect=true
jdbc.username=ldJ3on8H409DgCiOAH5/RQ==
jdbc.password=qqCfL+5Pmm7Qhe9HtdCQSw==
```

### 외부 DB 연동

Agent와 Normalizer는 외부 DB로 로그를 Export할 수 있습니다.

#### 설정 파일 위치

```
/CloudESM/app/normalizer/conf/export_db.properties
/CloudESM/app/agent/conf/db.properties
```

**주의**: 이 파일들은 **평문**으로 계정 정보를 저장합니다.

---

## 로그 설정

### Log4j2 설정

CloudESM은 **중앙집중식 로그 시스템**을 사용합니다.

#### 로그 디렉토리

| 디렉토리 | 설명 |
|----------|------|
| `/CloudESM/logs/` | 중앙 로그 디렉토리 |
| `/CloudESM/logs/.error/` | 에러 로그 전용 |
| `/CloudESM/app/[서비스]/logs/` | 개별 서비스 로그 (선택) |

#### Log4j2 설정 파일 위치

```
/CloudESM/app/www/ROOT/WEB-INF/conf/log4j2.properties
/CloudESM/app/analyzer/conf/log4j2.properties
/CloudESM/app/normalizer/conf/log4j2.properties
...
```

#### 로그 레벨 조정

**파일**: `log4j2.properties`

```properties
# 전체 로그 레벨
rootLogger.level = INFO

# 특정 패키지 로그 레벨
logger.seculayer.name = com.seculayer
logger.seculayer.level = DEBUG

# 출력 설정
appender.file.name = FILE
appender.file.type = RollingFile
appender.file.fileName = /CloudESM/logs/application.log
appender.file.filePattern = /CloudESM/logs/application-%d{yyyy-MM-dd}.log
appender.file.layout.type = PatternLayout
appender.file.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} [%t] %-5level %logger{36} - %msg%n
```

#### 주요 로그 파일

| 로그 파일 | 내용 |
|-----------|------|
| `SearchEngine.log` | 검색 엔진 로그 |
| `AnalyzeEngine.log` | 분석 엔진 로그 |
| `catalina.out` | Tomcat 로그 |
| `CDMEngine.log` | 데이터 관리 로그 |
| `Normalizer.log` | 정규화 엔진 로그 |

### 로그 파일 관리

#### 로그 로테이션

```bash
# 7일 이상 된 로그 삭제
find /CloudESM/logs/ -name "*.log" -mtime +7 -delete

# 로그 압축 (수동)
gzip /CloudESM/logs/application-2025-11-01.log
```

#### 디스크 사용량 확인

```bash
# 로그 디렉토리 크기
du -sh /CloudESM/logs/

# 큰 파일 찾기
du -h /CloudESM/logs/ | sort -rh | head -10
```

---

## 서비스 디렉토리 구조

### 전체 디렉토리

```
/CloudESM/
├── app/                    # 애플리케이션 서비스
│   ├── agent/              # 원격 로그 수집 에이전트
│   ├── analyzer/           # 보안 이벤트 분석
│   ├── analyzer_assistant/ # 분석 보조
│   ├── bigdata/            # 빅데이터 처리 (비활성)
│   ├── collector/          # 로그 수집
│   ├── java/zulu11/        # Java JDK 11
│   ├── messenger/          # 카카오 알림
│   ├── normalizer/         # 로그 정규화
│   ├── pms/                # 프로세스 관리 시스템
│   ├── procmonitor/        # 프로세스 모니터링
│   ├── reducer/            # 로그 집계/축소
│   ├── searcher/           # Lucene 검색 엔진
│   ├── shovel_server/      # 데이터 전송 서버
│   ├── soar_playbook_manager/ # SOAR 플레이북
│   ├── soar_ticket_manager/   # SOAR 티켓
│   ├── store/              # 데이터 관리 엔진
│   ├── tomcat9/            # Tomcat 웹 서버
│   ├── www/ROOT/           # 웹 애플리케이션
│   ├── start.sh            # 전체 서비스 시작
│   ├── stop.sh             # 전체 서비스 중지
│   └── version.sh          # 버전 정보
│
├── data/                   # 런타임 데이터
│   ├── processing/         # 처리 중인 데이터
│   ├── storage/            # 저장된 데이터
│   ├── samples/            # 샘플 데이터
│   └── seql/               # SEQL 쿼리
│
├── logs/                   # 중앙 로그 디렉토리
│   ├── SearchEngine.log
│   ├── AnalyzeEngine.log
│   ├── catalina.out
│   └── .error/             # 에러 로그
│
├── store/                  # 백업 및 정책
│   ├── backup/             # 백업 데이터
│   ├── compress/           # 압축 데이터
│   ├── policy/             # 정책 데이터
│   └── pms/                # PMS 데이터
│
└── tool/                   # 유틸리티 도구
```

### 주요 디렉토리 용도

| 디렉토리 | 용도 | 권한 |
|----------|------|------|
| `/CloudESM/app/` | 모든 서비스 바이너리 및 설정 | 755 |
| `/CloudESM/data/` | 런타임 데이터 저장 | 755 |
| `/CloudESM/logs/` | 중앙 로그 파일 | 755 |
| `/CloudESM/store/` | 백업 및 압축 데이터 | 755 |

---

## 환경 변수 설정

### Java 환경 변수

```bash
export JAVA_HOME=/CloudESM/app/java/zulu11
export PATH=$JAVA_HOME/bin:$PATH
```

### CloudESM 환경 변수

서비스 시작 스크립트에서 자동으로 설정됩니다:

```bash
export CLOUDESM_HOME=/CloudESM
export CLASSPATH=/CloudESM/app/[service]/lib/*
```

---

## 초기 설정 체크리스트

### 로컬 설치 (WSL2) 체크리스트

- [ ] WSL2 설치 및 Ubuntu 24.04 설정 완료
- [ ] 프로젝트를 WSL 네이티브 파일시스템으로 복사
- [ ] `/CloudESM` 심볼릭 링크 생성
- [ ] 필수 디렉토리 생성 (`logs`, `store`, `data`)
- [ ] Java 및 스크립트 실행 권한 설정
- [ ] CRLF → LF 변환 완료
- [ ] 고정 IP 설정 (172.26.94.100) - 선택사항
- [ ] DB 연결 테스트 성공 (10.1.34.69:13306)
- [ ] DB 설정 파일 업데이트 완료
- [ ] Log4j2 설정 확인
- [ ] 네트워크 연결 테스트 성공

### 서버 설치 (CentOS VM) 체크리스트

- [ ] CentOS 8 설치 완료
- [ ] VMware 네트워크를 Bridge 모드로 설정
- [ ] DNS 문제 해결 (`ping google.com` 성공)
- [ ] CentOS 8 Repository를 vault.centos.org로 변경
- [ ] 필수 패키지 설치 (glibc-langpack-ko, nmap, nmon)
- [ ] 방화벽 포트 오픈 (8443, 13306, 514, 6514, 10514)
- [ ] 라이센스 발급 완료 (MAC 주소 기반)
- [ ] CloudESM 설치 스크립트 실행 완료
- [ ] 타임존을 KST로 설정
- [ ] 서비스 시작 성공 (`ps -ef | grep cloudesm`)
- [ ] 웹 콘솔 접속 성공 (`https://<서버IP>:8443/`)
- [ ] SSH 접속 설정 완료 (선택사항)

---

## 서비스 관리 명령어 요약

### 전체 서비스 관리

```bash
# 서비스 시작
/CloudESM/app/start.sh

# 서비스 중지
/CloudESM/app/stop.sh

# 버전 확인
/CloudESM/app/version.sh
```

### Tomcat 관리

```bash
# 시작
/CloudESM/app/tomcat9/bin/startup.sh

# Foreground 시작 (로그 직접 확인)
/CloudESM/app/tomcat9/bin/catalina.sh run

# 중지
/CloudESM/app/tomcat9/bin/shutdown.sh

# 강제 종료
pkill -9 -f tomcat
```

### 웹 콘솔 접속

```bash
# 로컬 (WSL2)
https://localhost:8443/
https://172.26.94.100:8443/

# 서버 (CentOS)
https://<서버IP>:8443/
# 예시: https://10.1.11.161:8443/
```

**기본 계정**:
- ID: `admin`
- PW: `admin@123`

---

## 다음 단계

환경 설정이 완료되었다면 다음 문서를 참고하세요:

- **서비스 시작 및 관리**: 운영관리.md (예정)
- **로그 확인 방법**: 운영관리.md (예정)
- **기능 개발 가이드**: 기능개발.md (예정)
- **문제 해결**: 이슈사항.md (예정)

---

[← 통합매뉴얼로 돌아가기](../통합매뉴얼.md)

**작성일**: 2025-11-05 | **버전**: 1.1 | **업데이트**: 서버 설치 방법 추가
